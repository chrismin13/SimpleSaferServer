{% extends "base.html" %}

{% block title %}Network File Sharing - Simple Safer Server{% endblock %}

{% block header %}Network File Sharing{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- System Status -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card" id="systemStatusCard">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-server"></i> System Status
                        <i class="fas fa-info-circle text-muted ms-2" 
                           data-bs-toggle="tooltip" 
                           data-bs-placement="top" 
                           title="Network file sharing system status"></i>
                    </h5>
                    <button id="restartSMB" class="btn btn-warning btn-sm">
                        <i class="fas fa-sync-alt"></i> Restart Services
                    </button>
                </div>
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <div class="d-flex align-items-center">
                                <span class="badge bg-secondary me-3" id="overallStatus">Checking...</span>
                                <span class="h6 mb-0" id="statusMessage">Checking system status...</span>
                            </div>
                        </div>
                        <div class="col-md-4 text-end">
                            <button class="btn btn-outline-secondary btn-sm" type="button" 
                                    data-bs-toggle="collapse" data-bs-target="#technicalDetails">
                                <i class="fas fa-cog"></i> Technical Details
                            </button>
                        </div>
                    </div>
                    
                    <!-- Collapsible Technical Details -->
                    <div class="collapse mt-3" id="technicalDetails">
                        <div class="card card-body bg-light">
                            <h6 class="mb-3">Service Details:</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="d-flex align-items-center mb-2">
                                        <span class="badge bg-secondary me-2" id="smbdStatus">Checking...</span>
                                        <span>SMB Daemon (smbd)</span>
                                        <i class="fas fa-info-circle text-muted ms-2" 
                                           data-bs-toggle="tooltip" 
                                           data-bs-placement="top" 
                                           title="Handles file and printer sharing between Windows and Linux systems"></i>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="d-flex align-items-center mb-2">
                                        <span class="badge bg-secondary me-2" id="nmbdStatus">Checking...</span>
                                        <span>NetBIOS Daemon (nmbd)</span>
                                        <i class="fas fa-info-circle text-muted ms-2" 
                                           data-bs-toggle="tooltip" 
                                           data-bs-placement="top" 
                                           title="Handles network discovery and name resolution for Windows compatibility"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Shares Management -->
    <div class="row">
        <div class="col-12">
            <div class="card" id="smbSharesCard">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        SMB Shares
                        <i class="fas fa-info-circle text-muted ms-2" 
                           data-bs-toggle="tooltip" 
                           data-bs-placement="top" 
                           title="Manage network file shares that users can access"></i>
                    </h5>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addShareModal">
                        <i class="fas fa-plus"></i> Add Share
                    </button>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>Share Name</th>
                                    <th>Path</th>
                                    <th>Writable</th>
                                    <th>Comment</th>
                                    <th>Users</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="sharesTableBody">
                                <tr>
                                    <td colspan="7" class="text-center">
                                        <div class="spinner-border spinner-border-sm" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                        Loading shares...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Share Modal -->
<div class="modal fade" id="addShareModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add SMB Share</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addShareForm" novalidate>
                    <div class="mb-3">
                        <label for="shareName" class="form-label">Share Name</label>
                        <input type="text" class="form-control" id="shareName" required 
                               pattern="[a-zA-Z0-9_-]+" 
                               data-bs-toggle="tooltip" 
                               data-bs-placement="top" 
                               title="Only letters, numbers, hyphens, and underscores allowed">
                        <div class="invalid-feedback">Please enter a valid share name (letters, numbers, hyphens, and underscores only)</div>
                        <div class="form-text">No spaces or special characters allowed</div>
                    </div>
                    <div class="mb-3">
                        <label for="sharePath" class="form-label">Path</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="sharePath" required value="{{ backup_mount_point }}">
                            <button class="btn btn-outline-secondary" type="button" id="browseSharePathBtn">
                                <i class="fas fa-folder-open"></i> Browse
                            </button>
                        </div>
                        <div class="invalid-feedback">Please enter a valid path</div>
                        <div class="form-text">Full path to the directory to share</div>
                    </div>
                    <div class="mb-3">
                        <label for="shareComment" class="form-label">Comment</label>
                        <input type="text" class="form-control" id="shareComment">
                        <div class="form-text">Optional description for the share</div>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="shareWritable" checked>
                            <label class="form-check-label" for="shareWritable">
                                Writable
                                <i class="fas fa-info-circle text-muted ms-1" 
                                   data-bs-toggle="tooltip" 
                                   data-bs-placement="top" 
                                   title="Allow users to create, modify, and delete files in this share"></i>
                            </label>
                        </div>
                        <div class="form-text">When enabled, users can save files to this share</div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Users with Access</label>
                        <div class="border rounded p-3" style="max-height: 200px; overflow-y: auto;">
                            <div id="shareUsersCheckboxes">
                                <!-- Users will be loaded dynamically -->
                            </div>
                        </div>
                        <div class="form-text">Select users who can access this share. Leave empty to allow all users.</div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveShareBtn">Add Share</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Share Modal -->
<div class="modal fade" id="editShareModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit SMB Share</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editShareForm" novalidate>
                    <input type="hidden" id="editShareOriginalName">
                    <div class="mb-3">
                        <label for="editShareName" class="form-label">Share Name</label>
                        <input type="text" class="form-control" id="editShareName" required 
                               pattern="[a-zA-Z0-9_-]+" 
                               data-bs-toggle="tooltip" 
                               data-bs-placement="top" 
                               title="Only letters, numbers, hyphens, and underscores allowed">
                        <div class="invalid-feedback">Please enter a valid share name (letters, numbers, hyphens, and underscores only)</div>
                        <div class="form-text">No spaces or special characters allowed</div>
                    </div>
                    <div class="mb-3">
                        <label for="editSharePath" class="form-label">Path</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="editSharePath" required>
                            <button class="btn btn-outline-secondary" type="button" id="browseEditSharePathBtn">
                                <i class="fas fa-folder-open"></i> Browse
                            </button>
                        </div>
                        <div class="invalid-feedback">Please enter a valid path</div>
                        <div class="form-text">Full path to the directory to share</div>
                    </div>
                    <div class="mb-3">
                        <label for="editShareComment" class="form-label">Comment</label>
                        <input type="text" class="form-control" id="editShareComment">
                        <div class="form-text">Optional description for the share</div>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="editShareWritable">
                            <label class="form-check-label" for="editShareWritable">
                                Writable
                                <i class="fas fa-info-circle text-muted ms-1" 
                                   data-bs-toggle="tooltip" 
                                   data-bs-placement="top" 
                                   title="Allow users to create, modify, and delete files in this share"></i>
                            </label>
                        </div>
                        <div class="form-text">When enabled, users can save files to this share</div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Users with Access</label>
                        <div class="border rounded p-3" style="max-height: 200px; overflow-y: auto;">
                            <div id="editShareUsersCheckboxes">
                                <!-- Users will be loaded dynamically -->
                            </div>
                        </div>
                        <div class="form-text">Select users who can access this share. Leave empty to allow all users.</div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="updateShareBtn">Update Share</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteShareModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Delete Share</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete the share "<span id="deleteShareName"></span>"?</p>
                <div class="alert alert-warning" role="alert">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Warning:</strong> This action cannot be undone.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteShareBtn">Delete</button>
            </div>
        </div>
    </div>
</div>

<!-- Folder Picker Modal -->
<div class="modal fade" id="folderPickerModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-folder-open me-2"></i>Select Folder</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-2">
                    <strong>Current Path:</strong>
                    <span id="pickerCurrentPath" class="text-monospace"></span>
                </div>
                <div class="mb-2">
                    <button class="btn btn-sm btn-outline-secondary" id="pickerUpBtn">
                        <i class="fas fa-level-up-alt"></i> Up
                    </button>
                </div>
                <div id="pickerDirsList" class="list-group mb-2" style="max-height: 350px; overflow-y: auto;"></div>
                <div id="pickerError" class="alert alert-danger d-none"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-outline-primary" id="pickerSelectCurrentBtn">Select This Folder</button>
            </div>
        </div>
    </div>
</div>

<script>
let shares = [];
let currentDeleteShare = null;
let allUsers = [];

// Load shares on page load
document.addEventListener('DOMContentLoaded', function() {
    loadShares();
    loadSMBStatus();
    loadUsers();
    
    // Initialize tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
    
    // Set up event listeners
    document.getElementById('saveShareBtn').addEventListener('click', addShare);
    document.getElementById('updateShareBtn').addEventListener('click', updateShare);
    document.getElementById('confirmDeleteShareBtn').addEventListener('click', deleteShare);
    document.getElementById('restartSMB').addEventListener('click', restartSMB);
    
    // Form validation listeners
    const addShareForm = document.getElementById('addShareForm');
    const editShareForm = document.getElementById('editShareForm');
    
    // Real-time validation for add share form
    addShareForm.querySelectorAll('input[required]').forEach(input => {
        input.addEventListener('input', function() {
            if (this.checkValidity()) {
                this.classList.remove('is-invalid');
                this.classList.add('is-valid');
            } else {
                this.classList.remove('is-valid');
                this.classList.add('is-invalid');
            }
        });
    });
    
    // Real-time validation for edit share form
    editShareForm.querySelectorAll('input[required]').forEach(input => {
        input.addEventListener('input', function() {
            if (this.checkValidity()) {
                this.classList.remove('is-invalid');
                this.classList.add('is-valid');
            } else {
                this.classList.remove('is-valid');
                this.classList.add('is-invalid');
            }
        });
    });
    
    // Reset validation states when modals are hidden
    document.getElementById('addShareModal').addEventListener('hidden.bs.modal', function() {
        addShareForm.classList.remove('was-validated');
        addShareForm.querySelectorAll('.is-valid, .is-invalid').forEach(input => {
            input.classList.remove('is-valid', 'is-invalid');
        });
    });
    
    document.getElementById('editShareModal').addEventListener('hidden.bs.modal', function() {
        editShareForm.classList.remove('was-validated');
        editShareForm.querySelectorAll('.is-valid, .is-invalid').forEach(input => {
            input.classList.remove('is-valid', 'is-invalid');
        });
    });

    document.getElementById('addShareModal').addEventListener('show.bs.modal', function() {
        // Reset the path input to the default backup mount point if empty or if previously closed
        const pathInput = document.getElementById('sharePath');
        if (!pathInput.value || pathInput.value === '' || pathInput.value === undefined) {
            pathInput.value = '{{ backup_mount_point }}';
        }
    });
});

function loadShares() {
    fetch('/api/smb/shares')
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                showAlert('Error loading shares: ' + data.error, 'danger');
                return;
            }
            shares = data.shares;
            renderSharesTable();
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('Failed to load shares', 'danger');
        });
}

function loadUsers() {
    fetch('/api/users')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                allUsers = data.users;
                populateUserSelects();
            }
        })
        .catch(error => {
            console.error('Error loading users:', error);
        });
}

function populateUserSelects() {
    const addCheckboxes = document.getElementById('shareUsersCheckboxes');
    const editCheckboxes = document.getElementById('editShareUsersCheckboxes');
    
    const checkboxHtml = allUsers.map(user => `
        <div class="form-check">
            <input class="form-check-input" type="checkbox" value="${user.username}" id="add_${user.username}">
            <label class="form-check-label" for="add_${user.username}">
                ${user.username}
                ${user.is_admin ? '<span class="badge bg-primary ms-1">Admin</span>' : ''}
            </label>
        </div>
    `).join('');
    
    const editCheckboxHtml = allUsers.map(user => `
        <div class="form-check">
            <input class="form-check-input" type="checkbox" value="${user.username}" id="edit_${user.username}">
            <label class="form-check-label" for="edit_${user.username}">
                ${user.username}
                ${user.is_admin ? '<span class="badge bg-primary ms-1">Admin</span>' : ''}
            </label>
        </div>
    `).join('');
    
    if (addCheckboxes) addCheckboxes.innerHTML = checkboxHtml;
    if (editCheckboxes) editCheckboxes.innerHTML = editCheckboxHtml;
}

function renderSharesTable() {
    const tbody = document.getElementById('sharesTableBody');
    
    if (shares.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center">No shares found</td></tr>';
        return;
    }
    
    tbody.innerHTML = shares.map(share => {
        const userList = share.valid_users && share.valid_users.length > 0 
            ? share.valid_users.join(', ') 
            : 'All users';
        
        return `
        <tr>
            <td><strong>${share.name}</strong></td>
            <td><code>${share.path}</code></td>
            <td>
                <span class="badge ${share.writable ? 'bg-success' : 'bg-secondary'}">
                    ${share.writable ? 'Yes' : 'No'}
                </span>
            </td>
            <td>${share.comment || '-'}</td>
            <td>
                <small class="text-muted">${userList}</small>
            </td>
            <td>
                <button class="btn btn-sm btn-outline-primary me-1" onclick="editShare('${share.name}')">
                    <i class="fas fa-edit"></i>
                </button>
                <button class="btn btn-sm btn-outline-danger" onclick="confirmDeleteShare('${share.name}')">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        </tr>
        `;
    }).join('');
}

function addShare() {
    const form = document.getElementById('addShareForm');
    const name = document.getElementById('shareName').value.trim();
    const path = document.getElementById('sharePath').value.trim();
    const comment = document.getElementById('shareComment').value.trim();
    const writable = document.getElementById('shareWritable').checked;
    const saveBtn = document.getElementById('saveShareBtn');
    
    // Clear previous validation states
    form.classList.remove('was-validated');
    
    // Validate form
    if (!form.checkValidity()) {
        form.classList.add('was-validated');
        return;
    }
    
    // Validate path format
    if (!path.startsWith('/')) {
        document.getElementById('sharePath').classList.add('is-invalid');
        showModalError('addShareModal', 'Path must be an absolute path starting with /');
        return;
    }
    
    // Get selected users from checkboxes
    const selectedUsers = Array.from(document.querySelectorAll('#shareUsersCheckboxes input[type="checkbox"]:checked'))
        .map(checkbox => checkbox.value);
    
    // Show loading state
    const originalText = saveBtn.innerHTML;
    saveBtn.disabled = true;
    saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Adding...';
    
    const shareData = {
        name: name,
        path: path,
        comment: comment,
        writable: writable,
        valid_users: selectedUsers
    };
    
    fetch('/api/smb/shares', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(shareData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            // Show error within the modal
            showModalError('addShareModal', 'Error adding share: ' + data.error);
        } else {
            const smbSharesCard = document.getElementById('smbSharesCard');
            showAlert('Share added successfully', 'success', smbSharesCard);
            bootstrap.Modal.getInstance(document.getElementById('addShareModal')).hide();
            form.reset();
            // Reset the writable checkbox to checked state
            document.getElementById('shareWritable').checked = true;
            loadShares();
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('Failed to add share', 'danger');
    })
    .finally(() => {
        // Restore button state
        saveBtn.disabled = false;
        saveBtn.innerHTML = originalText;
    });
}

function editShare(shareName) {
    const share = shares.find(s => s.name === shareName);
    if (!share) return;
    
    document.getElementById('editShareOriginalName').value = share.name;
    document.getElementById('editShareName').value = share.name;
    document.getElementById('editSharePath').value = share.path;
    document.getElementById('editShareComment').value = share.comment || '';
    document.getElementById('editShareWritable').checked = share.writable;
    
    // Set selected users
    Array.from(document.querySelectorAll('#editShareUsersCheckboxes input[type="checkbox"]')).forEach(checkbox => {
        checkbox.checked = share.valid_users && share.valid_users.includes(checkbox.value);
    });
    
    new bootstrap.Modal(document.getElementById('editShareModal')).show();
}

function updateShare() {
    const form = document.getElementById('editShareForm');
    const originalName = document.getElementById('editShareOriginalName').value;
    const name = document.getElementById('editShareName').value.trim();
    const path = document.getElementById('editSharePath').value.trim();
    const comment = document.getElementById('editShareComment').value.trim();
    const writable = document.getElementById('editShareWritable').checked;
    const updateBtn = document.getElementById('updateShareBtn');
    
    // Clear previous validation states
    form.classList.remove('was-validated');
    
    // Validate form
    if (!form.checkValidity()) {
        form.classList.add('was-validated');
        return;
    }
    
    // Validate path format
    if (!path.startsWith('/')) {
        document.getElementById('editSharePath').classList.add('is-invalid');
        showModalError('editShareModal', 'Path must be an absolute path starting with /');
        return;
    }
    
    // Get selected users from checkboxes
    const selectedUsers = Array.from(document.querySelectorAll('#editShareUsersCheckboxes input[type="checkbox"]:checked'))
        .map(checkbox => checkbox.value);
    
    // Show loading state
    const originalText = updateBtn.innerHTML;
    updateBtn.disabled = true;
    updateBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Updating...';
    
    const shareData = {
        name: name,
        path: path,
        comment: comment,
        writable: writable,
        valid_users: selectedUsers
    };
    
    fetch(`/api/smb/shares/${encodeURIComponent(originalName)}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(shareData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            // Show error within the modal
            showModalError('editShareModal', 'Error updating share: ' + data.error);
        } else {
            const smbSharesCard = document.getElementById('smbSharesCard');
            showAlert('Share updated successfully', 'success', smbSharesCard);
            bootstrap.Modal.getInstance(document.getElementById('editShareModal')).hide();
            loadShares();
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('Failed to update share', 'danger');
    })
    .finally(() => {
        // Restore button state
        updateBtn.disabled = false;
        updateBtn.innerHTML = originalText;
    });
}

function confirmDeleteShare(shareName) {
    currentDeleteShare = shareName;
    document.getElementById('deleteShareName').textContent = shareName;
    new bootstrap.Modal(document.getElementById('deleteShareModal')).show();
}

function deleteShare() {
    if (!currentDeleteShare) return;
    
    const deleteBtn = document.getElementById('confirmDeleteShareBtn');
    
    // Show loading state
    const originalText = deleteBtn.innerHTML;
    deleteBtn.disabled = true;
    deleteBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Deleting...';
    
    fetch(`/api/smb/shares/${encodeURIComponent(currentDeleteShare)}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            showAlert('Error deleting share: ' + data.error, 'danger');
        } else {
            const smbSharesCard = document.getElementById('smbSharesCard');
            showAlert('Share deleted successfully', 'success', smbSharesCard);
            bootstrap.Modal.getInstance(document.getElementById('deleteShareModal')).hide();
            currentDeleteShare = null;
            loadShares();
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('Failed to delete share', 'danger');
    })
    .finally(() => {
        // Restore button state
        deleteBtn.disabled = false;
        deleteBtn.innerHTML = originalText;
    });
}

function loadSMBStatus() {
    fetch('/api/smb/status')
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                updateOverallStatus('error', 'System Error', 'Unable to check system status');
                document.getElementById('smbdStatus').textContent = 'Error';
                document.getElementById('smbdStatus').className = 'badge bg-danger me-2';
                document.getElementById('nmbdStatus').textContent = 'Error';
                document.getElementById('nmbdStatus').className = 'badge bg-danger me-2';
                return;
            }
            
            // Update individual service statuses
            const smbdStatus = document.getElementById('smbdStatus');
            smbdStatus.textContent = data.smbd;
            smbdStatus.className = data.smbd === 'active' ? 'badge bg-success me-2' : 'badge bg-danger me-2';
            
            const nmbdStatus = document.getElementById('nmbdStatus');
            nmbdStatus.textContent = data.nmbd;
            nmbdStatus.className = data.nmbd === 'active' ? 'badge bg-success me-2' : 'badge bg-danger me-2';
            
            // Update overall status
            if (data.smbd === 'active' && data.nmbd === 'active') {
                updateOverallStatus('success', 'All Systems Operational', 'Network file sharing is working properly');
            } else if (data.smbd === 'active' || data.nmbd === 'active') {
                updateOverallStatus('warning', 'Partial System Status', 'Some services are not running properly');
            } else {
                updateOverallStatus('danger', 'System Issues', 'Network file sharing services are not running');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            updateOverallStatus('error', 'System Error', 'Unable to check system status');
            document.getElementById('smbdStatus').textContent = 'Error';
            document.getElementById('smbdStatus').className = 'badge bg-danger me-2';
            document.getElementById('nmbdStatus').textContent = 'Error';
            document.getElementById('nmbdStatus').className = 'badge bg-danger me-2';
        });
}

function updateOverallStatus(status, title, message) {
    const overallStatus = document.getElementById('overallStatus');
    const statusMessage = document.getElementById('statusMessage');
    
    overallStatus.textContent = title;
    statusMessage.textContent = message;
    
    // Update badge color based on status
    overallStatus.className = 'badge me-3';
    switch(status) {
        case 'success':
            overallStatus.className += ' bg-success';
            break;
        case 'warning':
            overallStatus.className += ' bg-warning';
            break;
        case 'danger':
            overallStatus.className += ' bg-danger';
            break;
        case 'error':
            overallStatus.className += ' bg-secondary';
            break;
        default:
            overallStatus.className += ' bg-secondary';
    }
}

function restartSMB() {
    const button = document.getElementById('restartSMB');
    const originalText = button.innerHTML;
    button.disabled = true;
    button.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Restarting...';
    
    fetch('/api/smb/restart', {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            showAlert('Error restarting SMB services: ' + data.error, 'danger');
        } else {
            const systemStatusCard = document.getElementById('systemStatusCard');
            showAlert('SMB services restarted successfully', 'success', systemStatusCard);
            setTimeout(loadSMBStatus, 2000); // Reload status after restart
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('Failed to restart SMB services', 'danger');
    })
    .finally(() => {
        button.disabled = false;
        button.innerHTML = originalText;
    });
}

function showModalError(modalId, message) {
    const modal = document.getElementById(modalId);
    const modalBody = modal.querySelector('.modal-body');
    
    // Remove any existing error alerts in this modal
    const existingAlerts = modalBody.querySelectorAll('.alert-danger');
    existingAlerts.forEach(alert => alert.remove());
    
    // Create error alert
    const alertDiv = document.createElement('div');
    alertDiv.className = 'alert alert-danger alert-dismissible fade show mb-3';
    alertDiv.innerHTML = `
        <i class="fas fa-exclamation-triangle me-2"></i>
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    // Insert at the top of modal body
    modalBody.insertBefore(alertDiv, modalBody.firstChild);
    
    // Auto-dismiss after 8 seconds
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 8000);
}

function showAlert(message, type, targetElement = null) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    if (targetElement) {
        // Insert the alert at the top of the specified target element
        targetElement.insertBefore(alertDiv, targetElement.firstChild);
    } else {
        // Insert the alert at the top of the main content area (default behavior)
        const mainContent = document.querySelector('main');
        mainContent.insertBefore(alertDiv, mainContent.firstChild);
    }
    
    // Scroll to the alert if it's not at the top
    if (targetElement) {
        targetElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
    } else {
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }
    
    // Auto-dismiss after 5 seconds
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}

// Folder Picker Logic
let pickerTargetInput = null;
let pickerCurrent = '/';
let pickerSelected = null;
let pickerParent = null;

// Custom backdrop for folder picker modal
function showFolderPickerBackdrop() {
    // Only add if not already present
    if (!document.querySelector('.custom-folder-backdrop')) {
        const backdrop = document.createElement('div');
        backdrop.className = 'modal-backdrop show custom-folder-backdrop';
        backdrop.style.zIndex = '1061'; // Above Bootstrap's .modal-backdrop (z-index 1050) and .modal (1055)
        document.body.appendChild(backdrop);
    }
}
function removeFolderPickerBackdrop() {
    const backdrop = document.querySelector('.custom-folder-backdrop');
    if (backdrop) backdrop.remove();
}

function openFolderPicker(targetInputId, initialPath = '/') {
    pickerTargetInput = document.getElementById(targetInputId);
    pickerCurrent = initialPath && initialPath.startsWith('/') ? initialPath : '/';
    pickerParent = null;
    loadPickerDirs(pickerCurrent);
    new bootstrap.Modal(document.getElementById('folderPickerModal')).show();
}

function loadPickerDirs(path) {
    fetch(`/api/list_dirs?path=${encodeURIComponent(path)}`)
        .then(r => r.json())
        .then(data => {
            if (data.error) {
                showPickerError(data.error);
                return;
            }
            pickerCurrent = data.path;
            pickerParent = data.parent;
            document.getElementById('pickerCurrentPath').textContent = pickerCurrent;
            const list = document.getElementById('pickerDirsList');
            list.innerHTML = '';
            if (data.dirs.length === 0) {
                const emptyMsg = document.createElement('div');
                emptyMsg.className = 'list-group-item disabled text-muted';
                emptyMsg.textContent = 'No subfolders in this directory.';
                list.appendChild(emptyMsg);
            } else {
                data.dirs.forEach(dir => {
                    const item = document.createElement('a');
                    item.className = 'list-group-item list-group-item-action';
                    item.textContent = dir;
                    item.title = dir;
                    item.setAttribute('role', 'button');
                    item.setAttribute('tabindex', '0');
                    item.addEventListener('click', function(e) {
                        // Single-click navigates into the folder
                        loadPickerDirs(pickerCurrent.replace(/\/$/, '') + '/' + dir);
                    });
                    list.appendChild(item);
                });
            }
            document.getElementById('pickerError').classList.add('d-none');
        })
        .catch(e => showPickerError('Failed to load directories'));
}

function showPickerError(msg) {
    const err = document.getElementById('pickerError');
    err.textContent = msg;
    err.classList.remove('d-none');
}

document.getElementById('browseSharePathBtn').addEventListener('click', function() {
    openFolderPicker('sharePath', document.getElementById('sharePath').value);
});
document.getElementById('browseEditSharePathBtn').addEventListener('click', function() {
    openFolderPicker('editSharePath', document.getElementById('editSharePath').value);
});
document.getElementById('pickerUpBtn').addEventListener('click', function() {
    if (pickerParent) {
        loadPickerDirs(pickerParent);
    }
});
document.getElementById('pickerSelectCurrentBtn').addEventListener('click', function() {
    if (pickerTargetInput) {
        pickerTargetInput.value = pickerCurrent;
        bootstrap.Modal.getInstance(document.getElementById('folderPickerModal')).hide();
    }
});

document.getElementById('folderPickerModal').addEventListener('show.bs.modal', function() {
    showFolderPickerBackdrop();
    // Raise z-index of folder picker modal if needed
    document.getElementById('folderPickerModal').style.zIndex = '1062';
});
document.getElementById('folderPickerModal').addEventListener('hidden.bs.modal', function() {
    removeFolderPickerBackdrop();
    document.getElementById('folderPickerModal').style.zIndex = '';
});
</script>
{% endblock %} 